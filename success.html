<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Thank you — Downloads</title>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/styles.css" />
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script>
      window.EMAILJS_CONFIG = window.EMAILJS_CONFIG || { serviceId: 'service_c25bo6c', templateId: 'template_mi7mbfn', publicKey: '9rCrKbba27RcCm_L8' };
    </script>
    <style>
      .success-wrap { max-width: 960px; margin: 40px auto 60px; }
      .section-header h1 { font-size: 32px; line-height: 1.2; margin: 0 0 6px; }
      .section-header p { color: #6b7280; margin: 0; }
      .downloads { display:grid; gap:14px; margin-top: 22px; }
      .card { border: 1px solid #e5e7eb; border-radius: 14px; background: #fff; box-shadow: 0 4px 14px rgba(17, 24, 39, 0.06); }
      .card-body { padding: 16px 18px; }
      .card-body h3 { margin: 0 0 10px; font-size: 18px; }
      .dl-actions { display: grid; grid-auto-flow: row; gap: 10px; }
      .dl-actions .btn-primary { display:inline-block; text-align:center; padding:10px 14px; border-radius:10px; background:#6c47ff; color:#fff; text-decoration:none; }
      .back-actions { margin-top: 26px; }
    </style>
  </head>
  <body>
    <header class="site-header">
      <div class="container header-inner">
        <a class="brand" href="/products.html"><span class="brand-logo" aria-hidden="true">B</span><span class="brand-text">Business Explique</span></a>
      </div>
    </header>

    <main class="container success-wrap" style="padding:0 20px;">
      <header class="section-header">
        <h1>Thank you! Your downloads are ready</h1>
        <p>We’ve prepared your files below.</p>
      </header>
      <p id="status">Loading your order…</p>
      <section id="downloads" class="downloads" aria-live="polite"></section>
      <p class="back-actions"><a class="btn" href="/products.html">Back to products</a></p>
    </main>

    <script>
      // Local product -> links mapping for flows without Stripe session (free/PayPal)
      var DEFAULT_LINKS = [
        'https://drive.google.com/file/d/1hHlcsfOf0w6QjxY2_CLp8kkfu0OBRWyT/view?usp=drive_link'
      ];
      var PRODUCT_LINKS = {
        'Top-Tier Management Explained': [
          'https://drive.google.com/file/d/top-tier-management-explained/view?usp=sharing'
        ],
        'Strategic Management Explained': [
          'https://drive.google.com/file/d/strategic-management-explained/view?usp=sharing'
        ],
        'Sales Strategies Explained': [
          'https://drive.google.com/file/d/sales-strategies-explained/view?usp=sharing'
        ],
        'Competitive Advantage Explained': [
          'https://drive.google.com/file/d/competitive-advantage-explained/view?usp=sharing'
        ],
        'Marketing Frameworks Explained': [
          'https://drive.google.com/file/d/marketing-frameworks-explained/view?usp=sharing'
        ],
        'Business Development Explained': [
          'https://drive.google.com/file/d/business-development-explained/view?usp=sharing'
        ],
        'Consulting Management Explained': [
          'https://drive.google.com/file/d/consulting-management-explained/view?usp=sharing'
        ],
        'Organizational Management Explained': [
          'https://drive.google.com/file/d/organizational-management-explained/view?usp=sharing'
        ],
        'Human Resources Explained': [
          'https://drive.google.com/file/d/human-resources-explained/view?usp=sharing'
        ],
        'Project Management Explained': [
          'https://drive.google.com/file/d/project-management-explained/view?usp=sharing'
        ],
        'Process Improvement Strategies Explained': [
          'https://drive.google.com/file/d/process-improvement-strategies-explained/view?usp=sharing'
        ],
        'Everything Explained Bundle': [
          'https://drive.google.com/file/d/top-tier-management-explained/view?usp=sharing',
          'https://drive.google.com/file/d/strategic-management-explained/view?usp=sharing',
          'https://drive.google.com/file/d/sales-strategies-explained/view?usp=sharing',
          'https://drive.google.com/file/d/competitive-advantage-explained/view?usp=sharing',
          'https://drive.google.com/file/d/marketing-frameworks-explained/view?usp=sharing',
          'https://drive.google.com/file/d/business-development-explained/view?usp=sharing',
          'https://drive.google.com/file/d/consulting-management-explained/view?usp=sharing',
          'https://drive.google.com/file/d/organizational-management-explained/view?usp=sharing',
          'https://drive.google.com/file/d/human-resources-explained/view?usp=sharing',
          'https://drive.google.com/file/d/project-management-explained/view?usp=sharing',
          'https://drive.google.com/file/d/process-improvement-strategies-explained/view?usp=sharing'
        ],
        'All Products Special': [
          'https://drive.google.com/file/d/top-tier-management-explained/view?usp=sharing',
          'https://drive.google.com/file/d/strategic-management-explained/view?usp=sharing',
          'https://drive.google.com/file/d/sales-strategies-explained/view?usp=sharing',
          'https://drive.google.com/file/d/competitive-advantage-explained/view?usp=sharing',
          'https://drive.google.com/file/d/marketing-frameworks-explained/view?usp=sharing',
          'https://drive.google.com/file/d/business-development-explained/view?usp=sharing',
          'https://drive.google.com/file/d/consulting-management-explained/view?usp=sharing',
          'https://drive.google.com/file/d/organizational-management-explained/view?usp=sharing',
          'https://drive.google.com/file/d/human-resources-explained/view?usp=sharing',
          'https://drive.google.com/file/d/project-management-explained/view?usp=sharing',
          'https://drive.google.com/file/d/process-improvement-strategies-explained/view?usp=sharing'
        ]
      };
      function linksFor(name){
        return PRODUCT_LINKS[name] || DEFAULT_LINKS;
      }
      function toDirectLink(url){
        try {
          if (!url) return url;
          var m = String(url).match(/https?:\/\/drive\.google\.com\/file\/d\/([^/]+)\//i);
          if (m && m[1]) return 'https://drive.google.com/uc?export=download&id=' + m[1];
          var u = new URL(url);
          if (u.hostname.indexOf('drive.google.com') !== -1 && u.searchParams.get('id')) {
            return 'https://drive.google.com/uc?export=download&id=' + u.searchParams.get('id');
          }
          return url;
        } catch(_) { return url; }
      }
      function clearCartStorage(){
        try { localStorage.setItem('cart', '[]'); } catch(_) {}
        try { localStorage.removeItem('couponZero'); localStorage.removeItem('couponZeroName'); } catch(_) {}
        try { localStorage.removeItem('stripePending'); localStorage.removeItem('paypalPending'); } catch(_) {}
      }
      function getCartTotalEUR(){
        try {
          var raw = localStorage.getItem('cart');
          if (!raw) return '';
          var arr = JSON.parse(raw)||[];
          var total = arr.reduce(function(sum, it){ return sum + (Number(it.price||0) * Number(it.qty||1)); }, 0);
          if (!isFinite(total) || total<=0) return '';
          return '€' + total.toFixed(2);
        } catch(_) { return ''; }
      }
      function sendDownloadsViaEmailJS(to, items){
        try {
          if(!to || !/\S+@\S+\.\S+/.test(to)) return;
          var cfg = (window.EMAILJS_CONFIG||{});
          if(!window.emailjs || !cfg.serviceId || !cfg.templateId || !cfg.publicKey) return;
          try{ window.emailjs.init(cfg.publicKey); }catch(e){}
          var links = [];
          var summary = Array.isArray(items)? items.map(function(it){ (it.links||[]).forEach(function(l){links.push(l)}); return (it.name||'Produit'); }).join(', '):'';
          var firstItem = (Array.isArray(items) && items[0]) ? items[0] : null;
          var productName = firstItem && firstItem.name ? firstItem.name : 'Your product';
          var productLink = (firstItem && Array.isArray(firstItem.links) && firstItem.links[0]) ? firstItem.links[0] : '';
          var customerName = (to && String(to).split('@')[0]) || 'Customer';
          var message = 'Click the button to download your file. If it expires, just reply to this email.';
          // Build HTML buttons for all links
          var linksHtml = Array.isArray(items) ? items.map(function(it){
            var name = it.name || 'Product';
            var buttons = (it.links||[]).map(function(href, idx){
              var dl = toDirectLink(href);
              return '<a href="'+dl+'" target="_blank" rel="noopener" style="display:inline-block;margin:6px 8px 0 0;padding:10px 14px;background:#6c47ff;color:#ffffff;text-decoration:none;border-radius:8px;">Download '+(idx+1)+'</a>';
            }).join('');
            return '<div style="margin:10px 0 14px 0;padding:12px;border:1px solid #eee;border-radius:10px;background:#fafaff;">\n' +
                   '  <div style="font-weight:600;margin-bottom:6px;">'+name+'</div>\n' +
                   '  <div>'+buttons+'</div>\n' +
                   '</div>';
          }).join('') : '';
          var firstDirect = toDirectLink(productLink || links[0] || '');
          var priceText = getCartTotalEUR();
          window.emailjs.send(cfg.serviceId, cfg.templateId, {
            to_email: to,
            customer_name: customerName,
            // User's EmailJS template fields
            product_name: productName,
            product_link: firstDirect,
            download_link: firstDirect,
            price: priceText,
            message: message,
            // Existing fallback fields
            items_summary: summary,
            links_text: links.join('\n'),
            links_html: linksHtml
          }).catch(function(){});
        } catch(e){}
      }
      function shouldSendOnce(id){
        try{ if(!id) return false; var key = 'sent:'+id; if(localStorage.getItem(key)==='1') return false; localStorage.setItem(key,'1'); return true; }catch(_){ return true; }
      }
      function getCartItemsNames(){
        try { var raw = localStorage.getItem('cart'); if(!raw) return []; var arr = JSON.parse(raw)||[]; return arr.map(function(it){ return (it && it.name) ? it.name : 'Your purchase'; }); } catch(_) { return []; }
      }
      function renderItems(items, box){
        items.forEach(function(it){
          var card = document.createElement('div');
          card.className = 'card';
          var inner = document.createElement('div');
          inner.className = 'card-body';
          inner.innerHTML = '<h3>'+ (it.name||'Your purchase') +'</h3>';
          var actions = document.createElement('div');
          actions.className = 'dl-actions';
          (it.links||[]).forEach(function(href, idx){
            var a = document.createElement('a');
            a.className = 'btn btn-primary';
            // Route via API with readable name in URL
            var url = new URL(location.origin + '/api/dl');
            url.searchParams.set('name', String(it.name||'Product'));
            url.searchParams.set('i', String(idx));
            a.href = url.toString(); a.target = '_blank'; a.rel = 'noopener';
            a.textContent = (it.name || ('Download '+(idx+1)));
            actions.appendChild(a);
          });
          inner.appendChild(actions);
          card.appendChild(inner);
          box.appendChild(card);
        });
      }
      (async function(){
        const qp = new URLSearchParams(location.search);
        const sessionId = qp.get('session_id');
        const successFlag = qp.get('success');
        const pp = qp.get('pp') || qp.get('paypal');
        const token = qp.get('token');
        const payer = qp.get('PayerID');
        const statusEl = document.getElementById('status');
        const box = document.getElementById('downloads');
        // FREE coupon flow: show local items and email links
        try {
          if (qp.get('free') === '1') {
            statusEl.textContent = '';
            var namesF = getCartItemsNames();
            const items = (namesF.length ? namesF : ['Your purchase']).map(function(nm){
              return { name: nm, links: linksFor(nm) };
            });
            renderItems(items, box);
            try{ var emailF = localStorage.getItem('buyerEmail') || ''; if(emailF && shouldSendOnce('free:1')) sendDownloadsViaEmailJS(emailF, items); }catch(e){}
            try { clearCartStorage(); } catch(_){ }
            // Clean URL
            const url = new URL(location.href);
            url.searchParams.delete('free');
            history.replaceState({}, '', url);
            return;
          }
        } catch(_){}
        // If PayPal returned with token + PayerID, capture order then show links
        if (!sessionId && token && payer) {
          try {
            const res = await fetch('/api/paypal/capture-order', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ token, payer })
            });
            const d = await res.json();
            var names = getCartItemsNames();
            const items = (names.length ? names : ['Your purchase']).map(function(nm){
              return { name: nm, links: linksFor(nm) };
            });
            statusEl.textContent = '';
            renderItems(items, box);
            try{ var email = localStorage.getItem('buyerEmail') || ''; if(email && shouldSendOnce('paypal:'+token)) sendDownloadsViaEmailJS(email, items); }catch(e){}
            try { clearCartStorage(); } catch(_){ }
          } catch (e) {
            statusEl.textContent = 'Error finalizing PayPal order';
          } finally {
            const url = new URL(location.href);
            url.searchParams.delete('token');
            url.searchParams.delete('PayerID');
            history.replaceState({}, '', url);
          }
          return;
        }
        // If PayPal flow redirected here, show default links and send email
        if (!sessionId && pp === '1') {
          statusEl.textContent = '';
          var names2 = getCartItemsNames();
          const items = (names2.length ? names2 : ['Your purchase']).map(function(nm){
            return { name: nm, links: linksFor(nm) };
          });
          renderItems(items, box);
          try{ var email = localStorage.getItem('buyerEmail') || ''; if(email && shouldSendOnce('paypal:pp1')) sendDownloadsViaEmailJS(email, items); }catch(e){}
          try { clearCartStorage(); } catch(_){ }
          // Clean URL
          const url = new URL(location.href);
          url.searchParams.delete('pp');
          url.searchParams.delete('paypal');
          history.replaceState({}, '', url);
          return;
        }
        // Final fallback: if we came from PayPal (or pending flag) but no params, still show links and send email
        try {
          var cameFromPaypal = document.referrer && /paypal\.com/i.test(document.referrer);
          var pending = false; try { pending = (localStorage.getItem('paypalPending') === '1'); } catch(_){}
          if (!sessionId && !pp && (cameFromPaypal || pending)) {
            statusEl.textContent = '';
            var names3 = getCartItemsNames();
            var items = (names3.length ? names3 : ['Your purchase']).map(function(nm){
              return { name: nm, links: linksFor(nm) };
            });
            renderItems(items, box);
            try{ var email2 = localStorage.getItem('buyerEmail') || ''; if(email2 && shouldSendOnce('paypal:referrer')) sendDownloadsViaEmailJS(email2, items); }catch(e){}
            try { clearCartStorage(); } catch(_){ }
            try{ localStorage.removeItem('paypalPending'); }catch(_){ }
            return;
          }
        } catch (_) {}
        // Stripe fallback: if success=1 but no session_id, still show default links and email
        if (!sessionId && successFlag === '1') {
          statusEl.textContent = '';
          var namesS = getCartItemsNames();
          const items = (namesS.length ? namesS : ['Your purchase']).map(function(nm){
            return { name: nm, links: linksFor(nm) };
          });
          renderItems(items, box);
          try{ var email0 = localStorage.getItem('buyerEmail') || ''; if(email0 && shouldSendOnce('stripe:successFlag')) sendDownloadsViaEmailJS(email0, items); }catch(e){}
          try { clearCartStorage(); } catch(_){ }
          return;
        }
        if (!sessionId) {
          statusEl.textContent = 'Missing session_id in URL';
          return;
        }
        try {
          const res = await fetch('/api/order-links?session_id=' + encodeURIComponent(sessionId));
          const data = await res.json();
          if (!res.ok || !data?.ok) throw new Error(data?.message || 'Could not load order');
          statusEl.textContent = '';
          if (!data.items?.length) {
            box.innerHTML = '<p>No items found in this order.</p>';
            return;
          }
          renderItems(data.items.map(function(it){ return { name: it.name, links: it.links }; }), box);
          try{ var email = localStorage.getItem('buyerEmail') || ''; if(email && shouldSendOnce('stripe:'+sessionId)) sendDownloadsViaEmailJS(email, data.items); }catch(e){}
          try { clearCartStorage(); } catch(_){ }
        } catch (e) {
          statusEl.textContent = '';
          // Fallback: best-effort links based on cart names if available
          var namesFB = getCartItemsNames();
          const items = (namesFB.length ? namesFB : ['Your purchase']).map(function(nm){
            return { name: nm, links: linksFor(nm) };
          });
          renderItems(items, box);
          try{ var emailF = localStorage.getItem('buyerEmail') || ''; if(emailF && shouldSendOnce('stripe:fallback')) sendDownloadsViaEmailJS(emailF, items); }catch(err){}
          try { clearCartStorage(); } catch(_){ }
        }
      })();
    </script>
  </body>
</html>
