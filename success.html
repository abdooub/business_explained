<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Thank you — Downloads</title>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/styles.css" />
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script>
      window.EMAILJS_CONFIG = window.EMAILJS_CONFIG || { serviceId: 'service_c25bo6c', templateId: 'template_mi7mbfn', publicKey: '9rCrKbba27RcCm_L8' };
    </script>
    <style>
      .success-wrap { max-width: 960px; margin: 40px auto 60px; }
      .section-header h1 { font-size: 32px; line-height: 1.2; margin: 0 0 6px; }
      .section-header p { color: #6b7280; margin: 0; }
      .downloads { display:grid; gap:14px; margin-top: 22px; }
      .card { border: 1px solid #e5e7eb; border-radius: 14px; background: #fff; box-shadow: 0 4px 14px rgba(17, 24, 39, 0.06); }
      .card-body { padding: 16px 18px; }
      .card-body h3 { margin: 0 0 10px; font-size: 18px; }
      .dl-actions { display: grid; grid-auto-flow: row; gap: 10px; }
      .dl-actions .btn-primary { display:inline-block; text-align:center; padding:10px 14px; border-radius:10px; background:#6c47ff; color:#fff; text-decoration:none; }
      .back-actions { margin-top: 26px; }
    </style>
  </head>
  <body>
    <header class="site-header">
      <div class="container header-inner">
        <a class="brand" href="/products.html"><span class="brand-logo" aria-hidden="true">B</span><span class="brand-text">Business Explained</span></a>
      </div>
    </header>

    <main class="container success-wrap" style="padding:0 20px;">
      <header class="section-header">
        <h1>Thank you! Your downloads are ready</h1>
        <p>We’ve prepared your files below.</p>
      </header>
      <p id="status">Loading your order…</p>
      <section id="downloads" class="downloads" aria-live="polite"></section>
      <p class="back-actions"><a class="btn" href="/products.html">Back to products</a></p>
    </main>

    <script>
      function sendDownloadsViaEmailJS(to, items){
        try {
          if(!to || !/\S+@\S+\.\S+/.test(to)) return;
          var cfg = (window.EMAILJS_CONFIG||{});
          if(!window.emailjs || !cfg.serviceId || !cfg.templateId || !cfg.publicKey) return;
          try{ window.emailjs.init(cfg.publicKey); }catch(e){}
          var links = [];
          var summary = Array.isArray(items)? items.map(function(it){ (it.links||[]).forEach(function(l){links.push(l)}); return (it.name||'Produit'); }).join(', '):'';
          window.emailjs.send(cfg.serviceId, cfg.templateId, { to_email: to, items_summary: summary, links_text: links.join('\n') }).catch(function(){});
        } catch(e){}
      }
      function getCartItemsNames(){
        try { var raw = localStorage.getItem('cart'); if(!raw) return []; var arr = JSON.parse(raw)||[]; return arr.map(function(it){ return (it && it.name) ? it.name : 'Your purchase'; }); } catch(_) { return []; }
      }
      function renderItems(items, box){
        items.forEach(function(it){
          var card = document.createElement('div');
          card.className = 'card';
          var inner = document.createElement('div');
          inner.className = 'card-body';
          inner.innerHTML = '<h3>'+ (it.name||'Your purchase') +'</h3>';
          var actions = document.createElement('div');
          actions.className = 'dl-actions';
          (it.links||[]).forEach(function(href, idx){
            var a = document.createElement('a');
            a.className = 'btn btn-primary';
            a.href = href; a.target = '_blank'; a.rel = 'noopener';
            a.textContent = 'Download '+(idx+1);
            actions.appendChild(a);
          });
          inner.appendChild(actions);
          card.appendChild(inner);
          box.appendChild(card);
        });
      }
      (async function(){
        const qp = new URLSearchParams(location.search);
        const sessionId = qp.get('session_id');
        const successFlag = qp.get('success');
        const pp = qp.get('pp') || qp.get('paypal');
        const token = qp.get('token');
        const payer = qp.get('PayerID');
        const statusEl = document.getElementById('status');
        const box = document.getElementById('downloads');
        // If PayPal returned with token + PayerID, capture order then show links
        if (!sessionId && token && payer) {
          try {
            const res = await fetch('/api/paypal/capture-order', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ token, payer })
            });
            const d = await res.json();
            var names = getCartItemsNames();
            const items = (names.length ? names : ['Your purchase']).map(function(nm){ return { name: nm, links: [
              'https://drive.google.com/file/d/1hHlcsfOf0w6QjxY2_CLp8kkfu0OBRWyT/view?usp=drive_link'
            ] }; });
            statusEl.textContent = '';
            renderItems(items, box);
            try{ var email = localStorage.getItem('buyerEmail') || ''; if(email) sendDownloadsViaEmailJS(email, items); }catch(e){}
          } catch (e) {
            statusEl.textContent = 'Error finalizing PayPal order';
          } finally {
            const url = new URL(location.href);
            url.searchParams.delete('token');
            url.searchParams.delete('PayerID');
            history.replaceState({}, '', url);
          }
          return;
        }
        // If PayPal flow redirected here, show default links and send email
        if (!sessionId && pp === '1') {
          statusEl.textContent = '';
          var names2 = getCartItemsNames();
          const items = (names2.length ? names2 : ['Your purchase']).map(function(nm){ return { name: nm, links: [
            'https://drive.google.com/file/d/1hHlcsfOf0w6QjxY2_CLp8kkfu0OBRWyT/view?usp=drive_link'
          ] }; });
          renderItems(items, box);
          try{ var email = localStorage.getItem('buyerEmail') || ''; if(email) sendDownloadsViaEmailJS(email, items); }catch(e){}
          // Clean URL
          const url = new URL(location.href);
          url.searchParams.delete('pp');
          url.searchParams.delete('paypal');
          history.replaceState({}, '', url);
          return;
        }
        // Final fallback: if we came from PayPal (or pending flag) but no params, still show links and send email
        try {
          var cameFromPaypal = document.referrer && /paypal\.com/i.test(document.referrer);
          var pending = false; try { pending = (localStorage.getItem('paypalPending') === '1'); } catch(_){}
          if (!sessionId && !pp && (cameFromPaypal || pending)) {
            statusEl.textContent = '';
            var names3 = getCartItemsNames();
            var items = (names3.length ? names3 : ['Your purchase']).map(function(nm){ return { name: nm, links: [
              'https://drive.google.com/file/d/1hHlcsfOf0w6QjxY2_CLp8kkfu0OBRWyT/view?usp=drive_link'
            ] }; });
            renderItems(items, box);
            try{ var email2 = localStorage.getItem('buyerEmail') || ''; if(email2) sendDownloadsViaEmailJS(email2, items); }catch(e){}
            try{ localStorage.removeItem('paypalPending'); }catch(_){ }
            return;
          }
        } catch (_) {}
        // Stripe fallback: if success=1 but no session_id, still show default links and email
        if (!sessionId && successFlag === '1') {
          statusEl.textContent = '';
          var namesS = getCartItemsNames();
          const items = (namesS.length ? namesS : ['Your purchase']).map(function(nm){ return { name: nm, links: [
            'https://drive.google.com/file/d/1hHlcsfOf0w6QjxY2_CLp8kkfu0OBRWyT/view?usp=drive_link'
          ] }; });
          renderItems(items, box);
          try{ var email0 = localStorage.getItem('buyerEmail') || ''; if(email0) sendDownloadsViaEmailJS(email0, items); }catch(e){}
          return;
        }
        if (!sessionId) {
          statusEl.textContent = 'Missing session_id in URL';
          return;
        }
        try {
          const res = await fetch('/api/order-links?session_id=' + encodeURIComponent(sessionId));
          const data = await res.json();
          if (!res.ok || !data?.ok) throw new Error(data?.message || 'Could not load order');
          statusEl.textContent = '';
          if (!data.items?.length) {
            box.innerHTML = '<p>No items found in this order.</p>';
            return;
          }
          renderItems(data.items.map(function(it){ return { name: it.name, links: it.links }; }), box);
          try{ var email = localStorage.getItem('buyerEmail') || ''; if(email) sendDownloadsViaEmailJS(email, data.items); }catch(e){}
        } catch (e) {
          statusEl.textContent = '';
          // Fallback: show default Stripe link and email so user is not blocked
          const items = [{ name: 'Your purchase', links: [
            'https://drive.google.com/file/d/1hHlcsfOf0w6QjxY2_CLp8kkfu0OBRWyT/view?usp=drive_link'
          ] }];
          renderItems(items, box);
          try{ var emailF = localStorage.getItem('buyerEmail') || ''; if(emailF) sendDownloadsViaEmailJS(emailF, items); }catch(err){}
        }
      })();
    </script>
  </body>
</html>
